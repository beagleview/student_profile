{% extends 'students/base.html' %}

{% block title %}Holland Career Interest Test - {{ student.full_name }}{% endblock %}

{% block content %}
<div class="flex justify-center">
    <div class="w-full max-w-5xl">
        <div class="bg-white rounded-lg shadow-lg">
            <div class="bg-blue-600 text-white rounded-t-lg px-6 py-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h4 class="text-xl font-semibold mb-2">
                            <i class="fas fa-briefcase mr-2"></i>Holland Career Interest Test
                        </h4>
                        <p class="text-blue-100 mb-0">แบบทดสอบความสนใจอาชีพตามทฤษฎี Dr. John L Holland</p>
                    </div>
                    <div>
                        <span class="bg-white text-gray-800 px-3 py-1 rounded-full text-sm font-medium">{{ student.full_name }}</span>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Student Info -->
                <div class="row mb-4">
                    <div class="col-md-3 text-center">
                        {% if student.photo %}
                            <img src="{{ student.photo.url }}" alt="{{ student.full_name }}" 
                                 class="student-photo mb-2">
                        {% else %}
                            <div class="student-photo bg-light d-flex align-items-center justify-content-center mb-2">
                                <i class="fas fa-user fa-2x text-muted"></i>
                            </div>
                        {% endif %}
                        <h6 class="text-primary">{{ student.full_name }}</h6>
                        <small class="text-muted">ม.{{ student.level }}/{{ student.room }}</small>
                    </div>
                    <div class="col-md-9">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>คำแนะนำในการทำแบบทดสอบ
                            </h6>
                            <p class="mb-2">
                                แบบทดสอบนี้จะประเมินความสนใจของคุณใน 6 ประเภทบุคลิกภาพอาชีพตามทฤษฎี RIASEC:
                            </p>
                            <ul class="mb-2 small">
                                <li><strong>Realistic (R)</strong> - นักสำรวจ: ชอบงานที่ใช้ทักษะทางกายภาพ</li>
                                <li><strong>Investigative (I)</strong> - นักวิจัย: ชอบคิดวิเคราะห์และแก้ปัญหา</li>
                                <li><strong>Artistic (A)</strong> - นักสร้างสรรค์: ชอบงานสร้างสรรค์และศิลปะ</li>
                                <li><strong>Social (S)</strong> - นักสังคม: ชอบช่วยเหลือและทำงานกับคน</li>
                                <li><strong>Enterprising (E)</strong> - นักผจญภัย: ชอบการขาย ธุรกิจ และความเป็นผู้นำ</li>
                                <li><strong>Conventional (C)</strong> - นักระบบ: ชอบงานที่เป็นระเบียบและมีระบบ</li>
                            </ul>
                            <p class="mb-0 small text-muted">กรุณาให้คะแนนตามความสนใจจริงของคุณ (0-100 คะแนน)</p>
                        </div>
                    </div>
                </div>

                <!-- Test Form -->
                <form method="post" id="hollandTestForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Realistic -->
                            <div class="card border-danger mb-3">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-tools me-2"></i>นักสำรวจ (Realistic)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form.realistic_score.label_tag }}
                                        {{ form.realistic_score }}
                                        <div class="form-text">งานที่ใช้มือ เครื่องมือ เครื่องจักร หรือทำงานกลางแจ้ง</div>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-danger realistic-progress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted realistic-percent">0%</small>
                                </div>
                            </div>

                            <!-- Investigative -->
                            <div class="card border-warning mb-3">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-microscope me-2"></i>นักวิจัย (Investigative)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form.investigative_score.label_tag }}
                                        {{ form.investigative_score }}
                                        <div class="form-text">งานวิเคราะห์ วิจัย แก้ปัญหา หรือทำงานทางวิทยาศาสตร์</div>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-warning investigative-progress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted investigative-percent">0%</small>
                                </div>
                            </div>

                            <!-- Artistic -->
                            <div class="card border-success mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-palette me-2"></i>นักสร้างสรรค์ (Artistic)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form.artistic_score.label_tag }}
                                        {{ form.artistic_score }}
                                        <div class="form-text">งานสร้างสรรค์ ศิลปะ ดนตรี การเขียน หรือการออกแบบ</div>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success artistic-progress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted artistic-percent">0%</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <!-- Social -->
                            <div class="card border-info mb-3">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-users me-2"></i>นักสังคม (Social)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form.social_score.label_tag }}
                                        {{ form.social_score }}
                                        <div class="form-text">งานช่วยเหลือผู้อื่น สอน ให้คำปรึกษา หรือบริการ</div>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-info social-progress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted social-percent">0%</small>
                                </div>
                            </div>

                            <!-- Enterprising -->
                            <div class="card border-primary mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>นักผจญภัย (Enterprising)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form.enterprising_score.label_tag }}
                                        {{ form.enterprising_score }}
                                        <div class="form-text">งานขาย ธุรกิจ การเป็นผู้นำ หรือการจัดการ</div>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-primary enterprising-progress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted enterprising-percent">0%</small>
                                </div>
                            </div>

                            <!-- Conventional -->
                            <div class="card border-secondary mb-3">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-clipboard-list me-2"></i>นักระบบ (Conventional)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        {{ form.conventional_score.label_tag }}
                                        {{ form.conventional_score }}
                                        <div class="form-text">งานที่เป็นระเบียบ มีระบบ บัญชี หรือธุรการ</div>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-secondary conventional-progress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted conventional-percent">0%</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Holland Code Preview -->
                    <div class="card border-primary mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0 text-primary">
                                <i class="fas fa-code me-2"></i>Holland Code Preview
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2">รหัสบุคลิกภาพอาชีพของคุณ:</p>
                                    <h4 class="text-primary" id="hollandCodePreview">---</h4>
                                </div>
                                <div class="col-md-6">
                                    <canvas id="previewChart" width="200" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Primary and Secondary Types -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.primary_type.label_tag }}
                                {{ form.primary_type }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.secondary_type.label_tag }}
                                {{ form.secondary_type }}
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-save me-2"></i>บันทึกผลการทดสอบ
                            </button>
                            <a href="{% url 'student_personality' student.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>ยกเลิก
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .student-photo {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #f8f9fa;
    }
    
    .form-range {
        cursor: pointer;
    }
    
    .card-header h6 {
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .progress {
        margin-top: 8px;
        margin-bottom: 4px;
    }
    
    canvas {
        max-width: 100%;
        height: auto;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize preview chart
    const previewCtx = document.getElementById('previewChart').getContext('2d');
    const previewChart = new Chart(previewCtx, {
        type: 'radar',
        data: {
            labels: ['นักสำรวจ', 'นักวิจัย', 'นักสร้างสรรค์', 'นักสังคม', 'นักผจญภัย', 'นักระบบ'],
            datasets: [{
                label: 'Holland Score',
                data: [0, 0, 0, 0, 0, 0],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    angleLines: {
                        display: true
                    },
                    suggestedMin: 0,
                    suggestedMax: 100,
                    ticks: {
                        stepSize: 25,
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Score inputs
    const scoreInputs = {
        realistic: document.getElementById('id_realistic_score'),
        investigative: document.getElementById('id_investigative_score'),
        artistic: document.getElementById('id_artistic_score'),
        social: document.getElementById('id_social_score'),
        enterprising: document.getElementById('id_enterprising_score'),
        conventional: document.getElementById('id_conventional_score')
    };

    // Progress bars and percentages
    const progressBars = {
        realistic: document.querySelector('.realistic-progress'),
        investigative: document.querySelector('.investigative-progress'),
        artistic: document.querySelector('.artistic-progress'),
        social: document.querySelector('.social-progress'),
        enterprising: document.querySelector('.enterprising-progress'),
        conventional: document.querySelector('.conventional-progress')
    };

    const percentLabels = {
        realistic: document.querySelector('.realistic-percent'),
        investigative: document.querySelector('.investigative-percent'),
        artistic: document.querySelector('.artistic-percent'),
        social: document.querySelector('.social-percent'),
        enterprising: document.querySelector('.enterprising-percent'),
        conventional: document.querySelector('.conventional-percent')
    };

    // Update progress bars and chart
    function updateProgress() {
        const scores = {};
        
        // Update individual progress bars
        Object.keys(scoreInputs).forEach(key => {
            const value = parseInt(scoreInputs[key].value) || 0;
            scores[key] = value;
            
            progressBars[key].style.width = value + '%';
            percentLabels[key].textContent = value + '%';
        });

        // Update chart
        previewChart.data.datasets[0].data = [
            scores.realistic,
            scores.investigative,
            scores.artistic,
            scores.social,
            scores.enterprising,
            scores.conventional
        ];
        previewChart.update();

        // Calculate Holland Code
        const sortedScores = Object.entries(scores)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3);

        const codeMap = {
            realistic: 'R',
            investigative: 'I',
            artistic: 'A',
            social: 'S',
            enterprising: 'E',
            conventional: 'C'
        };

        const hollandCode = sortedScores.map(([key, value]) => codeMap[key]).join('');
        document.getElementById('hollandCodePreview').textContent = hollandCode;

        // Update primary and secondary dropdowns
        const primarySelect = document.getElementById('id_primary_type');
        const secondarySelect = document.getElementById('id_secondary_type');
        
        if (sortedScores.length > 0) {
            primarySelect.value = sortedScores[0][0].toUpperCase();
        }
        if (sortedScores.length > 1) {
            secondarySelect.value = sortedScores[1][0].toUpperCase();
        }
    }

    // Add event listeners to all score inputs
    Object.values(scoreInputs).forEach(input => {
        input.addEventListener('input', updateProgress);
        input.addEventListener('change', updateProgress);
    });

    // Initial update
    updateProgress();
});
</script>
{% endblock %}

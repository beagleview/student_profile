{% extends 'students/base.html' %}

{% block title %}{{ title }} - Student Management System{% endblock %}

{% block content %}
<div class="flex justify-center">
    <div class="w-full max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg">
            <div class="bg-primary-600 text-white rounded-t-lg px-6 py-4">
                <h4 class="text-xl font-semibold mb-0">
                    <i class="fas fa-user-plus mr-2"></i>{{ title }}
                </h4>
            </div>
            <div class="p-6">
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <!-- Student Identification -->
                    <div class="mb-8">
                        <div class="mb-6">
                            <h5 class="text-lg font-semibold text-primary-600 border-b border-gray-200 pb-2">
                                <i class="fas fa-id-card mr-2"></i>Student Identification
                            </h5>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.student_id.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.student_id.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.student_id }}
                                <div class="mt-1 text-sm text-gray-500">{{ form.student_id.help_text }}</div>
                                {% if form.student_id.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.student_id.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.student_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.student_number.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.student_number }}
                                <div class="mt-1 text-sm text-gray-500">{{ form.student_number.help_text }}</div>
                                {% if form.student_number.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.student_number.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information -->
                    <div class="mb-8">
                        <div class="mb-6">
                            <h5 class="text-lg font-semibold text-primary-600 border-b border-gray-200 pb-2">
                                <i class="fas fa-user mr-2"></i>Personal Information
                            </h5>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.photo.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.photo.label }}
                                </label>
                                {{ form.photo }}
                                <div class="mt-1 text-sm text-gray-500">{{ form.photo.help_text }}</div>
                                {% if form.photo.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.photo.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                {% if student and student.photo %}
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Photo</label>
                                        <img src="{{ student.photo.url }}" alt="Current photo" class="w-20 h-20 rounded-full object-cover border-2 border-gray-200">
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.first_name.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.first_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.last_name.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.last_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.sex.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.sex.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.sex }}
                                {% if form.sex.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.sex.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.date_of_birth.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.date_of_birth.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.date_of_birth }}
                                <div class="mt-1 text-sm text-gray-500">{{ form.date_of_birth.help_text }}</div>
                                {% if form.date_of_birth.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.date_of_birth.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Academic Information -->
                    <div class="mb-8">
                        <div class="mb-6">
                            <h5 class="text-lg font-semibold text-primary-600 border-b border-gray-200 pb-2">
                                <i class="fas fa-graduation-cap mr-2"></i>Academic Information
                            </h5>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.level.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.level.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.level }}
                                <div class="mt-1 text-sm text-gray-500">{{ form.level.help_text }}</div>
                                {% if form.level.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.level.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.room.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ form.room.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.room }}
                                <div class="mt-1 text-sm text-gray-500">{{ form.room.help_text }}</div>
                                {% if form.room.errors %}
                                    <div class="mt-1 text-sm text-red-500">
                                        {% for error in form.room.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <a href="{% url 'student_list' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium transition-colors inline-flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Cancel
                        </a>
                        <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white px-8 py-3 rounded-lg font-medium text-lg transition-colors inline-flex items-center">
                            <i class="fas fa-save mr-2"></i>
                            {% if student %}Update Student{% else %}Enroll Student{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Preview uploaded image
    document.getElementById('{{ form.photo.id_for_label }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Create or update preview image
                let preview = document.getElementById('photo-preview');
                if (!preview) {
                    preview = document.createElement('img');
                    preview.id = 'photo-preview';
                    preview.className = 'student-photo mt-2';
                    preview.alt = 'Photo preview';
                    e.target.parentNode.appendChild(preview);
                }
                preview.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Auto-generate student ID suggestion
    const firstNameField = document.getElementById('{{ form.first_name.id_for_label }}');
    const lastNameField = document.getElementById('{{ form.last_name.id_for_label }}');
    const studentIdField = document.getElementById('{{ form.student_id.id_for_label }}');

    function generateStudentId() {
        const firstName = firstNameField.value.trim();
        const lastName = lastNameField.value.trim();
        
        if (firstName && lastName && !studentIdField.value) {
            const suggestion = 'STD' + firstName.substring(0, 2).toUpperCase() + 
                             lastName.substring(0, 2).toUpperCase() + 
                             Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            studentIdField.placeholder = `Suggestion: ${suggestion}`;
        }
    }

    firstNameField.addEventListener('blur', generateStudentId);
    lastNameField.addEventListener('blur', generateStudentId);
</script>
{% endblock %}
